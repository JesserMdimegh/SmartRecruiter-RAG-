{% extends "hr_base.html" %}
{% block title %}SmartRecruitAI - CV Ranking System{% endblock %}
{% block nav_cv_ranking_class %}active{% endblock %}
{% block extra_head %}
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .step {
            margin-bottom: 40px;
            padding: 30px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            background: #fafafa;
            transition: all 0.3s ease;
        }

        .step:hover {
            border-color: #4facfe;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.1);
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .step-title {
            font-size: 1.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .job-details {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
        }

        .job-details h4 {
            color: #4facfe;
            margin-bottom: 10px;
        }

        .job-detail-item {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
        }

        .job-detail-label {
            font-weight: 600;
            margin-right: 10px;
            min-width: 120px;
            color: #666;
        }

        .candidates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .candidate-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .candidate-card:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.2);
        }

        .candidate-card.selected {
            border-color: #4facfe;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.05) 0%, rgba(0, 242, 254, 0.05) 100%);
        }

        .candidate-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .candidate-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .candidate-email {
            color: #666;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .candidate-position {
            color: #4facfe;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .candidate-skills {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .skill-tag {
            background: #f0f8ff;
            color: #4facfe;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .soft-skills-input {
            margin-top: 15px;
        }

        .soft-skills-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .soft-skill-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .soft-skill-tag .remove {
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .progress-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .progress-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .progress-header h3 {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #6c757d;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            border: 3px solid #e9ecef;
        }

        .step-circle.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-color: #4facfe;
            transform: scale(1.1);
        }

        .step-circle.completed {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-color: #28a745;
        }

        .step-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: center;
            max-width: 120px;
        }

        .step-label.active {
            color: #4facfe;
            font-weight: 600;
        }

        .step-label.completed {
            color: #28a745;
            font-weight: 600;
        }

        .progress-line {
            position: absolute;
            top: 25px;
            left: 10%;
            right: 10%;
            height: 3px;
            background: #e9ecef;
            z-index: 1;
        }

        .progress-line-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-bar-container {
            background: #e9ecef;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-message {
            text-align: center;
            color: #666;
            font-size: 1rem;
            margin-top: 15px;
        }

        .candidate-preview {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .candidate-preview:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.2);
        }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .preview-title {
            display: flex;
            align-items: center;
        }

        .preview-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            margin-right: 20px;
        }

        .preview-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .preview-position {
            color: #4facfe;
            font-weight: 500;
            font-size: 1.1rem;
        }

        .preview-contact {
            text-align: right;
        }

        .preview-email {
            color: #666;
            margin-bottom: 5px;
        }

        .preview-experience {
            color: #28a745;
            font-weight: 500;
        }

        .preview-section {
            margin-bottom: 25px;
        }

        .preview-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .preview-section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            margin-right: 10px;
            border-radius: 2px;
        }

        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .skill-category {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .skill-category-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .skill-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .skill-badge {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%);
            color: #4facfe;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid rgba(79, 172, 254, 0.2);
        }

        .links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .link-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-decoration: none;
            color: #495057;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }

        .link-item:hover {
            background: white;
            border-color: #4facfe;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.2);
        }

        .link-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            border-radius: 4px;
        }

        .link-text {
            font-weight: 500;
        }

        .certifications-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .certification-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
        }

        .certification-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .certification-content {
            flex: 1;
        }

        .certification-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .certification-details {
            font-size: 0.9rem;
            color: #666;
        }

        .preview-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .btn-preview {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-continue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-continue:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3);
        }

        .btn-skip {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e9ecef;
        }

        .btn-skip:hover {
            background: #e9ecef;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            margin-top: 40px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #f0f0f0;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .ranked-candidate {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .ranked-candidate:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .rank-badge {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-weight: bold;
            margin-right: 15px;
        }

        .score-display {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .overall-score {
            font-size: 2rem;
            font-weight: bold;
            color: #4facfe;
            margin-left: auto;
        }

        .score-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .score-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .score-item-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .score-item-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .explanation {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .strengths, .gaps {
            margin-top: 15px;
        }

        .strength-item {
            color: #28a745;
            margin-bottom: 5px;
        }

        .gap-item {
            color: #dc3545;
            margin-bottom: 5px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
    </style>
{% endblock %}
{% block content %}
    <div class="container">
        <div class="header">
            <h1>üéØ SmartRecruitAI</h1>
            <p>Advanced CV Ranking & Matching System</p>
        </div>

        <div class="content">
            <!-- Step 1: Select Job Offer -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Select Job Offer</div>
                </div>
                
                <div class="form-group">
                    <label for="jobOffer">Choose a job offer to match candidates against:</label>
                    <select id="jobOffer" onchange="loadJobDetails()">
                        <option value="">-- Select a Job Offer --</option>
                    </select>
                </div>

                <div id="jobDetails" class="job-details" style="display: none;">
                    <h4>Job Details</h4>
                    <div id="jobDetailsContent"></div>
                </div>
            </div>

            <!-- Step 3: Select Candidates -->
            <div class="step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Select Candidates to Rank</div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="selectAll" onchange="toggleAllCandidates()"> 
                        Select All Candidates
                    </label>
                </div>

                <div id="candidatesGrid" class="candidates-grid">
                    <!-- Candidates will be loaded here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="resetSelection()">Reset</button>
                <button class="btn btn-primary" id="rankButton" onclick="rankCandidates()" disabled>
                    Rank Selected Candidates
                </button>
            </div>

            <!-- Enhanced Loading State with Progress -->
            <div id="loading" class="loading">
                <div class="progress-container">
                    <div class="progress-header">
                        <h3>üîç Analyzing Candidates</h3>
                        <p>Our AI is processing and ranking candidates based on comprehensive analysis</p>
                    </div>
                    
                    <div class="progress-steps">
                        <div class="progress-step">
                            <div class="step-circle" id="step1">1</div>
                            <div class="step-label">Extracting Data</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle" id="step2">2</div>
                            <div class="step-label">Skills Analysis</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle" id="step3">3</div>
                            <div class="step-label">Experience Matching</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle" id="step4">4</div>
                            <div class="step-label">Soft Skills Evaluation</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-circle" id="step5">5</div>
                            <div class="step-label">Final Ranking</div>
                        </div>
                        <div class="progress-line">
                            <div class="progress-line-fill" id="progressLineFill"></div>
                        </div>
                    </div>
                    
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="progressBarFill"></div>
                    </div>
                    
                    <div class="progress-message" id="progressMessage">
                        Initializing analysis engine...
                    </div>
                </div>
                
                <div class="spinner"></div>
            </div>

            <!-- Candidate Preview Section -->
            <div id="candidatePreview" class="loading">
                <div class="progress-container">
                    <div class="progress-header">
                        <h3>üë§ Candidate Preview</h3>
                        <p>Review extracted information before final ranking</p>
                    </div>
                    
                    <div id="previewContent">
                        <!-- Candidate previews will be loaded here -->
                    </div>
                    
                    <div class="preview-actions">
                        <button class="btn-preview btn-skip" onclick="skipPreview()">Skip All</button>
                        <button class="btn-preview btn-continue" onclick="continueToResults()">Continue to Results</button>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="results" class="results">
                <div class="result-header">
                    <h2>üèÜ Ranking Results</h2>
                    <p>Comprehensive analysis and ranking of selected candidates</p>
                </div>

                <div id="summaryStats" class="summary-stats">
                    <!-- Summary statistics will be loaded here -->
                </div>

                <div id="rankedCandidates">
                    <!-- Ranked candidates will be loaded here -->
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
        let jobOffers = [];
        let candidates = [];
        let selectedCandidates = new Set();
        let rankingResults = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadJobOffers();
            loadCandidates();
        });

        // Progress tracking functions
        function updateProgress(step, message, progress) {
            // Update step circles
            for (let i = 1; i <= 5; i++) {
                const stepCircle = document.getElementById(`step${i}`);
                const stepLabel = stepCircle.nextElementSibling;
                
                if (i < step) {
                    stepCircle.className = 'step-circle completed';
                    stepLabel.className = 'step-label completed';
                } else if (i === step) {
                    stepCircle.className = 'step-circle active';
                    stepLabel.className = 'step-label active';
                } else {
                    stepCircle.className = 'step-circle';
                    stepLabel.className = 'step-label';
                }
            }
            
            // Update progress bars
            document.getElementById('progressLineFill').style.width = `${progress}%`;
            document.getElementById('progressBarFill').style.width = `${progress}%`;
            document.getElementById('progressMessage').textContent = message;
        }

        function showCandidatePreview(candidatesData) {
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = '';
            
            candidatesData.forEach((candidate, index) => {
                const previewCard = createCandidatePreviewCard(candidate, index + 1);
                previewContent.appendChild(previewCard);
            });
            
            document.getElementById('loading').classList.remove('show');
            document.getElementById('candidatePreview').classList.add('show');
        }

        function createCandidatePreviewCard(candidate, rank) {
            const card = document.createElement('div');
            card.className = 'candidate-preview';
            
            // Get initials for avatar
            const initials = candidate.full_name ? candidate.full_name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 'CN';
            
            // Extract links from metadata or CV text
            const links = extractLinks(candidate);
            
            // Format certifications
            const certifications = candidate.certifications || [];
            
            card.innerHTML = `
                <div class="preview-header">
                    <div class="preview-title">
                        <div class="preview-avatar">${initials}</div>
                        <div>
                            <div class="preview-name">${candidate.full_name || 'Unnamed Candidate'}</div>
                            <div class="preview-position">${candidate.current_position || 'Position not specified'}</div>
                        </div>
                    </div>
                    <div class="preview-contact">
                        <div class="preview-email">${candidate.email || 'No email'}</div>
                        <div class="preview-experience">${candidate.total_experience_years || 0} years experience</div>
                    </div>
                </div>

                <div class="preview-section">
                    <div class="preview-section-title">üíº Skills & Expertise</div>
                    <div class="skills-grid">
                        <div class="skill-category">
                            <div class="skill-category-title">Technical Skills</div>
                            <div class="skill-list">
                                ${(candidate.technical_skills || []).slice(0, 8).map(skill => 
                                    `<span class="skill-badge">${skill}</span>`
                                ).join('')}
                                ${(candidate.technical_skills || []).length > 8 ? 
                                    `<span class="skill-badge">+${(candidate.technical_skills || []).length - 8} more</span>` : ''}
                            </div>
                        </div>
                        <div class="skill-category">
                            <div class="skill-category-title">Soft Skills</div>
                            <div class="skill-list">
                                ${(candidate.soft_skills || []).slice(0, 8).map(skill => 
                                    `<span class="skill-badge">${skill}</span>`
                                ).join('')}
                                ${(candidate.soft_skills || []).length > 8 ? 
                                    `<span class="skill-badge">+${(candidate.soft_skills || []).length - 8} more</span>` : ''}
                            </div>
                        </div>
                        <div class="skill-category">
                            <div class="skill-category-title">Languages</div>
                            <div class="skill-list">
                                ${(candidate.languages || []).map(lang => 
                                    `<span class="skill-badge">${lang}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                ${links.length > 0 ? `
                <div class="preview-section">
                    <div class="preview-section-title">üîó Professional Links</div>
                    <div class="links-grid">
                        ${links.map(link => `
                            <a href="${link.url}" target="_blank" class="link-item">
                                <div class="link-icon" style="background: ${link.color};">
                                    <span style="color: white; font-size: 12px; font-weight: bold;">${link.icon}</span>
                                </div>
                                <div class="link-text">${link.text}</div>
                            </a>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                ${certifications.length > 0 ? `
                <div class="preview-section">
                    <div class="preview-section-title">üèÜ Certifications</div>
                    <div class="certifications-list">
                        ${certifications.slice(0, 3).map(cert => `
                            <div class="certification-item">
                                <div class="certification-icon">‚úì</div>
                                <div class="certification-content">
                                    <div class="certification-name">${cert.name || cert}</div>
                                    <div class="certification-details">${cert.issuer || 'Certification'} ${cert.date ? '- ' + cert.date : ''}</div>
                                </div>
                            </div>
                        `).join('')}
                        ${certifications.length > 3 ? 
                            `<div class="certification-item">
                                <div class="certification-icon">+</div>
                                <div class="certification-content">
                                    <div class="certification-name">${certifications.length - 3} more certifications</div>
                                </div>
                            </div>` : ''}
                    </div>
                </div>
                ` : ''}

                <div class="preview-section">
                    <div class="preview-section-title">üìö Education</div>
                    <div style="color: #666; font-size: 1rem;">
                        ${candidate.education_level || 'Education level not specified'}
                    </div>
                </div>
            `;
            
            return card;
        }

        function extractLinks(candidate) {
            const links = [];
            const professionalLinks = candidate.professional_links || {};
            
            // GitHub links
            if (professionalLinks.github && professionalLinks.github.length > 0) {
                professionalLinks.github.forEach(url => {
                    links.push({
                        url: url,
                        text: 'GitHub Profile',
                        icon: 'G',
                        color: '#333'
                    });
                });
            }
            
            // LinkedIn links
            if (professionalLinks.linkedin && professionalLinks.linkedin.length > 0) {
                professionalLinks.linkedin.forEach(url => {
                    links.push({
                        url: url,
                        text: 'LinkedIn Profile',
                        icon: 'in',
                        color: '#0077b5'
                    });
                });
            }
            
            // GitLab links
            if (professionalLinks.gitlab && professionalLinks.gitlab.length > 0) {
                professionalLinks.gitlab.forEach(url => {
                    links.push({
                        url: url,
                        text: 'GitLab Profile',
                        icon: 'G',
                        color: '#fc6d26'
                    });
                });
            }
            
            // Portfolio links
            if (professionalLinks.portfolio && professionalLinks.portfolio.length > 0) {
                professionalLinks.portfolio.forEach(url => {
                    links.push({
                        url: url,
                        text: 'Portfolio',
                        icon: 'üåê',
                        color: '#4facfe'
                    });
                });
            }
            
            // Fallback to regex extraction if no professional_links data
            if (links.length === 0) {
                const cvText = candidate.cv_text || '';
                
                // GitHub links
                const githubMatches = cvText.match(/https?:\/\/(?:www\.)?github\.com\/[\w\-\.]+/gi);
                if (githubMatches) {
                    links.push({
                        url: githubMatches[0],
                        text: 'GitHub Profile',
                        icon: 'G',
                        color: '#333'
                    });
                }
                
                // LinkedIn links
                const linkedinMatches = cvText.match(/https?:\/\/(?:www\.)?linkedin\.com\/in\/[\w\-\.]+/gi);
                if (linkedinMatches) {
                    links.push({
                        url: linkedinMatches[0],
                        text: 'LinkedIn Profile',
                        icon: 'in',
                        color: '#0077b5'
                    });
                }
                
                // GitLab links
                const gitlabMatches = cvText.match(/https?:\/\/(?:www\.)?gitlab\.com\/[\w\-\.]+/gi);
                if (gitlabMatches) {
                    links.push({
                        url: gitlabMatches[0],
                        text: 'GitLab Profile',
                        icon: 'G',
                        color: '#fc6d26'
                    });
                }
                
                // Portfolio links
                const portfolioMatches = cvText.match(/https?:\/\/[\w\-\.]+\.(?:com|io|dev|me|co|net|org)\/?(?:[\w\-\/]*)/gi);
                if (portfolioMatches) {
                    portfolioMatches.forEach(url => {
                        if (!url.includes('github.com') && !url.includes('linkedin.com') && !url.includes('gitlab.com')) {
                            links.push({
                                url: url,
                                text: 'Portfolio',
                                icon: 'üåê',
                                color: '#4facfe'
                            });
                        }
                    });
                }
            }
            
            return links.slice(0, 6); // Limit to 6 links
        }

        function skipPreview() {
            document.getElementById('candidatePreview').classList.remove('show');
            displayResults(rankingResults);
        }

        function continueToResults() {
            document.getElementById('candidatePreview').classList.remove('show');
            displayResults(rankingResults);
        }

        // Load job offers from API
        async function loadJobOffers() {
            try {
                const response = await fetch('/api/job-offers/');
                jobOffers = await response.json();
                
                const select = document.getElementById('jobOffer');
                jobOffers.forEach(job => {
                    const option = document.createElement('option');
                    option.value = job.id;
                    option.textContent = `${job.title} - ${job.location}`;
                    select.appendChild(option);
                });
            } catch (error) {
                showError('Failed to load job offers: ' + error.message);
            }
        }

        // Load job details when selected
        async function loadJobDetails() {
            const jobId = document.getElementById('jobOffer').value;
            if (!jobId) {
                document.getElementById('jobDetails').style.display = 'none';
                return;
            }

            const job = jobOffers.find(j => j.id == jobId);
            if (!job) return;

            const detailsContent = document.getElementById('jobDetailsContent');
            detailsContent.innerHTML = `
                <div class="job-detail-item">
                    <span class="job-detail-label">Title:</span>
                    <span>${job.title}</span>
                </div>
                <div class="job-detail-item">
                    <span class="job-detail-label">Location:</span>
                    <span>${job.location}</span>
                </div>
                <div class="job-detail-item">
                    <span class="job-detail-label">Job Type:</span>
                    <span>${job.job_type}</span>
                </div>
                <div class="job-detail-item">
                    <span class="job-detail-label">Experience:</span>
                    <span>${job.required_experience_years || 0}+ years</span>
                </div>
                <div class="job-detail-item">
                    <span class="job-detail-label">Salary Range:</span>
                    <span>${job.salary_min || 'Not specified'} - ${job.salary_max || 'Not specified'} ${job.currency}</span>
                </div>
                <div class="job-detail-item">
                    <span class="job-detail-label">Required Skills:</span>
                    <span>${job.required_skills ? job.required_skills.join(', ') : 'None specified'}</span>
                </div>
            `;
            
            document.getElementById('jobDetails').style.display = 'block';
            updateRankButton();
        }

        // Load candidates from API
        async function loadCandidates() {
            try {
                const response = await fetch('/api/candidates/');
                candidates = await response.json();
                
                displayCandidates();
            } catch (error) {
                showError('Failed to load candidates: ' + error.message);
            }
        }

        // Display candidates in grid
        function displayCandidates() {
            const grid = document.getElementById('candidatesGrid');
            grid.innerHTML = '';

            candidates.forEach(candidate => {
                const card = document.createElement('div');
                card.className = 'candidate-card';
                card.onclick = () => toggleCandidate(candidate.id);
                
                const skillsHtml = candidate.technical_skills ? 
                    candidate.technical_skills.slice(0, 3).map(skill => 
                        `<span class="skill-tag">${skill}</span>`
                    ).join('') : '';

                card.innerHTML = `
                    <input type="checkbox" class="candidate-checkbox" id="candidate-${candidate.id}" 
                           ${selectedCandidates.has(candidate.id) ? 'checked' : ''}>
                    <div class="candidate-name">${candidate.full_name || 'Unnamed Candidate'}</div>
                    <div class="candidate-email">${candidate.email || 'No email'}</div>
                    <div class="candidate-position">${candidate.current_position || 'Position not specified'}</div>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                        Experience: ${candidate.total_experience_years || 0} years
                    </div>
                    <div class="candidate-skills">${skillsHtml}</div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Toggle candidate selection
        function toggleCandidate(candidateId) {
            const checkbox = document.getElementById(`candidate-${candidateId}`);
            const card = checkbox.closest('.candidate-card');
            
            if (selectedCandidates.has(candidateId)) {
                selectedCandidates.delete(candidateId);
                checkbox.checked = false;
                card.classList.remove('selected');
            } else {
                selectedCandidates.add(candidateId);
                checkbox.checked = true;
                card.classList.add('selected');
            }
            
            updateRankButton();
        }

        // Toggle all candidates
        function toggleAllCandidates() {
            const selectAll = document.getElementById('selectAll').checked;
            
            if (selectAll) {
                candidates.forEach(candidate => {
                    selectedCandidates.add(candidate.id);
                });
            } else {
                selectedCandidates.clear();
            }
            
            displayCandidates();
            updateRankButton();
        }

        // Update rank button state
        function updateRankButton() {
            const hasJob = document.getElementById('jobOffer').value;
            const hasCandidates = selectedCandidates.size > 0;
            const rankButton = document.getElementById('rankButton');
            
            rankButton.disabled = !(hasJob && hasCandidates);
        }

        // Rank candidates with enhanced progress tracking
        async function rankCandidates() {
            const jobId = document.getElementById('jobOffer').value;
            
            if (!jobId || selectedCandidates.size === 0) {
                showError('Please select a job offer and at least one candidate');
                return;
            }

            // Show enhanced loading with progress
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').classList.remove('show');
            document.getElementById('candidatePreview').classList.remove('show');

            try {
                // Step 1: Extracting Data
                updateProgress(1, 'Extracting candidate data and skills...', 20);
                await sleep(800);

                // Step 2: Skills Analysis
                updateProgress(2, 'Analyzing technical and soft skills...', 40);
                await sleep(1000);

                // Step 3: Experience Matching
                updateProgress(3, 'Matching experience with job requirements...', 60);
                await sleep(800);

                // Step 4: Soft Skills Evaluation
                updateProgress(4, 'Evaluating soft skills compatibility...', 80);
                await sleep(1000);

                // Step 5: Final Ranking
                updateProgress(5, 'Generating final rankings and insights...', 95);

                const response = await fetch(`/api/job-offers/${jobId}/rank_candidates/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        candidate_ids: Array.from(selectedCandidates)
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Ranking failed');
                }

                updateProgress(5, 'Analysis complete! Preparing candidate preview...', 100);
                await sleep(500);

                // Store results and show preview
                rankingResults = data;
                showCandidatePreview(data.ranked_candidates);
                
            } catch (error) {
                showError('Failed to rank candidates: ' + error.message);
                document.getElementById('loading').classList.remove('show');
            }
        }

        // Helper function for delays
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Display ranking results
        function displayResults(data) {
            // Display summary statistics
            const summaryStats = document.getElementById('summaryStats');
            const stats = data.ranking_summary;
            
            summaryStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total_candidates}</div>
                    <div class="stat-label">Total Candidates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.average_score}%</div>
                    <div class="stat-label">Average Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.highest_score}%</div>
                    <div class="stat-label">Highest Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.candidates_above_80}</div>
                    <div class="stat-label">Above 80%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.candidates_above_60}</div>
                    <div class="stat-label">Above 60%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.median_score}%</div>
                    <div class="stat-label">Median Score</div>
                </div>
            `;

            // Display ranked candidates
            const rankedContainer = document.getElementById('rankedCandidates');
            rankedContainer.innerHTML = '';

            data.ranked_candidates.forEach((candidate, index) => {
                const candidateCard = document.createElement('div');
                candidateCard.className = 'ranked-candidate';
                
                const strengthsHtml = candidate.strengths.map(s => 
                    `<div class="strength-item">‚úì ${s}</div>`
                ).join('');
                
                const gapsHtml = candidate.gaps.map(g => 
                    `<div class="gap-item">‚ö† ${g}</div>`
                ).join('');

                candidateCard.innerHTML = `
                    <div class="score-display">
                        <div style="display: flex; align-items: center;">
                            <div class="rank-badge">${candidate.rank}</div>
                            <div>
                                <div style="font-size: 1.3rem; font-weight: 600;">${candidate.full_name}</div>
                                <div style="color: #666;">${candidate.email} ‚Ä¢ ${candidate.current_position}</div>
                            </div>
                        </div>
                        <div class="overall-score">${candidate.overall_score}%</div>
                    </div>

                    <div class="score-breakdown">
                        <div class="score-item">
                            <div class="score-item-value">${candidate.technical_skill_score}%</div>
                            <div class="score-item-label">Technical Skills</div>
                        </div>
                        <div class="score-item">
                            <div class="score-item-value">${candidate.soft_skill_score}%</div>
                            <div class="score-item-label">Soft Skills</div>
                        </div>
                        <div class="score-item">
                            <div class="score-item-value">${candidate.experience_score}%</div>
                            <div class="score-item-label">Experience</div>
                        </div>
                        <div class="score-item">
                            <div class="score-item-value">${candidate.education_score}%</div>
                            <div class="score-item-label">Education</div>
                        </div>
                        <div class="score-item">
                            <div class="score-item-value">${candidate.similarity_score}%</div>
                            <div class="score-item-label">Similarity</div>
                        </div>
                    </div>

                    <div class="explanation">
                        <h4>Analysis</h4>
                        <p>${candidate.detailed_explanation}</p>
                        
                        ${strengthsHtml ? `<div class="strengths"><h5>Strengths:</h5>${strengthsHtml}</div>` : ''}
                        ${gapsHtml ? `<div class="gaps"><h5>Areas for Consideration:</h5>${gapsHtml}</div>` : ''}
                        
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                            <small>
                                <strong>Skills Match:</strong> ${candidate.skills_matched}/${candidate.skills_total} ‚Ä¢ 
                                <strong>Soft Skills Match:</strong> ${candidate.soft_skills_matched}/${candidate.soft_skills_total} ‚Ä¢ 
                                <strong>Experience:</strong> ${candidate.experience_meets_requirement ? '‚úì Meets requirement' : '‚ö† ' + candidate.experience_gap + ' years gap'}
                            </small>
                        </div>
                    </div>
                `;
                
                rankedContainer.appendChild(candidateCard);
            });

            document.getElementById('results').classList.add('show');
        }

        // Reset selection
        function resetSelection() {
            document.getElementById('jobOffer').value = '';
            document.getElementById('jobDetails').style.display = 'none';
            document.getElementById('selectAll').checked = false;
            selectedCandidates.clear();
            displayCandidates();
            document.getElementById('results').classList.remove('show');
            document.getElementById('candidatePreview').classList.remove('show');
            updateRankButton();
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.content').insertBefore(errorDiv, document.querySelector('.step'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
{% endblock %}
